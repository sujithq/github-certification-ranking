name: Generate GitHub Certifications Rankings

on:
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch:
    # Allow manual trigger

jobs:
  generate-rankings:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # Prevent workflow from running too long
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
      
      - name: Fetch certification data
        timeout-minutes: 45  # Limit data fetching to 45 minutes
        run: |
          chmod +x cert-github.sh
          
          # Comprehensive list of countries by continent
          COUNTRIES=(
            # Americas
            "Brazil" "United States" "Canada" "Mexico" "Argentina" "Chile" 
            "Colombia" "Peru" "Venezuela" "Ecuador" "Bolivia" "Paraguay" 
            "Uruguay" "Costa Rica" "Panama" "Guatemala" "Honduras" 
            "El Salvador" "Nicaragua" "Dominican Republic" "Cuba"
            
            # Europe
            "Germany" "France" "United Kingdom" "Spain" "Italy" "Netherlands" 
            "Poland" "Portugal" "Belgium" "Greece" "Sweden" "Austria" 
            "Switzerland" "Norway" "Denmark" "Finland" "Ireland" "Czech Republic"
            "Romania" "Hungary" "Ukraine" "Russia"
            
            # Asia
            "China" "India" "Japan" "South Korea" "Singapore" "Indonesia"
            "Thailand" "Vietnam" "Malaysia" "Philippines" "Bangladesh"
            "Pakistan" "Israel" "Turkey" "Saudi Arabia" "United Arab Emirates"
            
            # Oceania
            "Australia" "New Zealand" "Fiji" "Papua New Guinea"
            
            # Africa
            "South Africa" "Egypt" "Nigeria" "Kenya" "Morocco" "Ghana"
          )
          
          echo "Fetching certification data for ${#COUNTRIES[@]} countries..."
          echo "Started at: $(date)"
          
          FAILED_COUNTRIES=()
          SUCCESS_COUNT=0
          
          for country in "${COUNTRIES[@]}"; do
            echo "----------------------------------------"
            echo "Processing: $country"
            
            # Add timeout and retry logic for each country
            if timeout 120 ./cert-github.sh "$country"; then
              echo "✓ Success: $country"
              ((SUCCESS_COUNT++))
            else
              echo "✗ Failed: $country (timeout or error)"
              FAILED_COUNTRIES+=("$country")
            fi
            
            # Small delay to avoid rate limiting
            sleep 1
          done
          
          echo "========================================"
          echo "Completed at: $(date)"
          echo "Success: $SUCCESS_COUNT/${#COUNTRIES[@]}"
          
          if [ ${#FAILED_COUNTRIES[@]} -gt 0 ]; then
            echo "Failed countries: ${FAILED_COUNTRIES[*]}"
          fi
      
      - name: Generate rankings
        run: |
          python3 generate_rankings.py
      
      - name: Clean up CSV files
        run: |
          echo "Removing CSV files (they will be regenerated on next run)..."
          rm -f github-certs-*.csv
          echo "CSV files removed"
      
      - name: Commit and push rankings
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Add only the markdown files
          git add TOP10_*.md README.md
          
          # Remove CSV files from git if they were tracked
          git rm --cached github-certs-*.csv 2>/dev/null || true
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update GitHub Certifications Rankings - $(date +'%Y-%m-%d')"
            git push
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
